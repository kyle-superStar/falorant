---
const { lang = 'en' } = Astro.locals;
---

<div class="language-selector">
  <button
    id="language-button"
    class="p-2 hover:bg-accent-base/10 rounded-lg relative"
    type="button"
    aria-label="é€‰æ‹©è¯­è¨€"
  >
    <span class="text-accent-two">ğŸŒ</span>
  </button>
  <div 
    id="language-menu" 
    class="dropdown-menu hidden absolute bg-bgColor rounded-lg shadow-lg border border-special-lighter py-2"
  >
    <ul class="text-sm">
      <li>
        <button 
          class="w-full text-left px-4 py-2 hover:bg-accent-base/5 language-btn" 
          data-language="en"
        >
          English
        </button>
      </li>
      <li>
        <button 
          class="w-full text-left px-4 py-2 hover:bg-accent-base/5 language-btn" 
          data-language="zh"
        >
          ä¸­æ–‡
        </button>
      </li>
    </ul>
  </div>
</div>

<style>
  .language-selector {
    position: relative;
    display: inline-block;
  }

  .dropdown-menu {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    min-width: 120px;
    z-index: 9999;
    background-color: var(--bgColor);
  }

  /* ç¡®ä¿ä¸‹æ‹‰èœå•åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
  .language-selector:focus-within .dropdown-menu,
  .language-selector:hover .dropdown-menu,
  .dropdown-menu:not(.hidden) {
    z-index: 9999;
  }

  /* æ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœ */
  .dropdown-menu {
    transform-origin: top right;
    transition: all 0.1s ease-out;
  }

  .dropdown-menu:not(.hidden) {
    animation: dropdownShow 0.1s ease-out;
  }

  @keyframes dropdownShow {
    from {
      opacity: 0;
      transform: scale(0.95);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
</style>

<script>
  import i18next from '../i18n/config';

  // è·å–å½“å‰URLçš„è¯­è¨€å’Œè·¯å¾„
  function getCurrentPathInfo() {
    const path = window.location.pathname;
    const segments = path.split('/').filter(Boolean);
    const isLangPath = ['zh'].includes(segments[0]); // en æ˜¯é»˜è®¤è¯­è¨€ï¼Œä¸éœ€è¦åœ¨ URL ä¸­æ˜¾ç¤º
    const currentLang = isLangPath ? segments[0] : 'en';
    const restPath = isLangPath ? segments.slice(1) : segments;
    return { currentLang, restPath: restPath.length > 0 ? restPath : [''] };
  }

  // ç”Ÿæˆæ–°çš„URL
  function generateNewUrl(lang: string) {
    const { restPath } = getCurrentPathInfo();
    const basePath = window.location.origin;
    if (lang === 'en') {
      // è‹±è¯­æ˜¯é»˜è®¤è¯­è¨€ï¼Œä¸éœ€è¦è¯­è¨€å‰ç¼€
      return `${basePath}/${restPath.join('/')}`;
    }
    return `${basePath}/${lang}/${restPath.join('/')}`;
  }

  const button = document.getElementById('language-button');
  const menu = document.getElementById('language-menu');
  
  // åˆ‡æ¢èœå•æ˜¾ç¤º
  button?.addEventListener('click', (e) => {
    e.stopPropagation();
    e.preventDefault();
    menu?.classList.toggle('hidden');
  });

  // ç‚¹å‡»å¤–éƒ¨å…³é—­èœå•
  document.addEventListener('click', (event) => {
    if (!button?.contains(event.target as Node) && !menu?.contains(event.target as Node)) {
      menu?.classList.add('hidden');
    }
  });

  // è¯­è¨€åˆ‡æ¢
  document.querySelectorAll('.language-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const lang = btn.getAttribute('data-language');
      if (lang) {
        const newUrl = generateNewUrl(lang);
        await i18next.changeLanguage(lang);
        window.location.href = newUrl;
      }
    });
  });

  // é«˜äº®å½“å‰è¯­è¨€
  const { currentLang } = getCurrentPathInfo();
  document.querySelectorAll('.language-btn').forEach(btn => {
    const btnLang = btn.getAttribute('data-language');
    if (btnLang === currentLang) {
      btn.classList.add('bg-accent-base/10', 'font-semibold');
    }
  });

  // åˆå§‹åŒ–æ—¶æ›´æ–°ç¿»è¯‘
  document.addEventListener('DOMContentLoaded', async () => {
    const { currentLang } = getCurrentPathInfo();
    await i18next.changeLanguage(currentLang);
    document.documentElement.lang = currentLang;
  });
</script>